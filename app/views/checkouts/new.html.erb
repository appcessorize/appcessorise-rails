<% content_for :title, "Checkout - Appcessorise" %>

<div class="min-h-screen bg-gradient-to-br from-gray-50 to-blue-50 py-12">
  <%= render 'shared/navigation' %>

  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 mt-8">
    <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
      <!-- Header -->
      <div class="bg-gradient-to-r from-blue-600 to-purple-600 px-8 py-6">
        <h1 class="text-3xl font-bold text-white">Secure Checkout</h1>
        <p class="text-blue-100 mt-2">Complete your purchase securely with Stripe</p>
      </div>

      <div class="p-8">
        <!-- Order Summary -->
        <div class="bg-gray-50 rounded-xl p-6 mb-8">
          <h2 class="text-xl font-bold text-gray-900 mb-4">Order Summary</h2>
          <div class="space-y-3">
            <div class="flex justify-between">
              <span class="text-gray-600">Product:</span>
              <span class="font-semibold text-gray-900"><%= @product_name %></span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Price:</span>
              <span class="font-semibold text-gray-900">$<%= sprintf("%.2f", @product_price) %></span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Quantity:</span>
              <span class="font-semibold text-gray-900"><%= @quantity %></span>
            </div>
            <div class="border-t border-gray-200 pt-3 mt-3">
              <div class="flex justify-between">
                <span class="text-lg font-bold text-gray-900">Total:</span>
                <span class="text-2xl font-bold text-blue-600">$<%= sprintf("%.2f", @product_price * @quantity) %></span>
              </div>
            </div>
          </div>
        </div>

        <!-- Payment Form -->
        <div>
          <h2 class="text-xl font-bold text-gray-900 mb-4">Payment Information</h2>

          <form id="payment-form" data-client-secret="<%= @payment_intent.client_secret %>">
            <!-- Loading State -->
            <div id="payment-loading" class="mb-4">
              <label class="block text-sm font-semibold text-gray-700 mb-2">
                Payment Details
              </label>
              <div class="px-3 py-3 border border-gray-300 rounded-lg bg-gray-50 animate-pulse">
                <div class="h-10 bg-gray-200 rounded w-full"></div>
              </div>
            </div>

            <!-- Payment Element -->
            <div id="payment-element" class="mb-4 hidden">
              <!-- Stripe.js will insert the Payment Element here -->
            </div>

            <!-- Error messages -->
            <div id="payment-message" class="text-red-600 text-sm mb-4" role="alert"></div>

            <!-- Optional: Affiliate Code -->
            <div class="mb-6">
              <label for="affiliate_code" class="block text-sm font-semibold text-gray-700 mb-2">
                Referral Code (Optional)
              </label>
              <input
                type="text"
                id="affiliate_code"
                name="affiliate_code"
                placeholder="Enter referral code"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              >
            </div>

            <!-- Submit Button -->
            <button
              type="submit"
              id="submit-button"
              disabled
              class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-4 rounded-xl font-bold text-lg hover:from-blue-700 hover:to-purple-700 transition transform hover:scale-105 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <span id="button-text">Pay $<%= sprintf("%.2f", @product_price * @quantity) %></span>
              <span id="spinner" class="hidden">Processing...</span>
            </button>
          </form>

          <!-- Security Badge -->
          <div class="mt-6 flex items-center justify-center space-x-2 text-sm text-gray-500">
            <svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
            </svg>
            <span>Secured by Stripe - Your payment information is encrypted</span>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<!-- Stripe.js -->
<script src="https://js.stripe.com/v3/"></script>
<script>
  // Initialize Stripe with your publishable key
  const stripe = Stripe('<%= Rails.configuration.stripe[:publishable_key] %>');

  // Get client secret from form
  const clientSecret = document.getElementById('payment-form').dataset.clientSecret;

  // Create Payment Element with appearance customization
  const appearance = {
    theme: 'stripe',
    variables: {
      colorPrimary: '#2563eb',
      colorBackground: '#ffffff',
      colorText: '#1f2937',
      colorDanger: '#dc2626',
      fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
      spacingUnit: '4px',
      borderRadius: '8px'
    }
  };

  const elements = stripe.elements({
    clientSecret,
    appearance
  });

  // Create and mount the Payment Element
  const paymentElement = elements.create('payment', {
    layout: {
      type: 'accordion',
      defaultCollapsed: false,
      radios: false,
      spacedAccordionItems: false
    },
    wallets: {
      applePay: 'auto',
      googlePay: 'auto'
    },
    defaultValues: {
      billingDetails: {
        address: {
          country: 'US'
        }
      }
    }
  });

  // Show Payment Element when ready
  const loadingDiv = document.getElementById('payment-loading');
  const paymentElementDiv = document.getElementById('payment-element');
  const submitButton = document.getElementById('submit-button');

  paymentElement.on('ready', function() {
    // Hide loading skeleton
    loadingDiv.classList.add('hidden');
    // Show payment element
    paymentElementDiv.classList.remove('hidden');
    // Enable submit button
    submitButton.disabled = false;
  });

  paymentElement.mount('#payment-element');

  // Handle form submission
  const form = document.getElementById('payment-form');
  const messageContainer = document.getElementById('payment-message');
  const buttonText = document.getElementById('button-text');
  const spinner = document.getElementById('spinner');

  form.addEventListener('submit', async function(event) {
    event.preventDefault();

    // Disable the button and show spinner
    submitButton.disabled = true;
    buttonText.classList.add('hidden');
    spinner.classList.remove('hidden');

    // Confirm the payment using the Payment Element
    const { error } = await stripe.confirmPayment({
      elements,
      confirmParams: {
        return_url: `${window.location.origin}/checkout/success`,
      },
    });

    // This point will only be reached if there is an immediate error when
    // confirming the payment. Otherwise, customer will be redirected to return_url.
    if (error) {
      if (error.type === 'card_error' || error.type === 'validation_error') {
        messageContainer.textContent = error.message;
      } else {
        messageContainer.textContent = 'An unexpected error occurred.';
      }

      // Re-enable button
      submitButton.disabled = false;
      buttonText.classList.remove('hidden');
      spinner.classList.add('hidden');
    }
  });
</script>
