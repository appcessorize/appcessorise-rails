<% content_for :title, "Checkout - Appcessorise" %>

<div class="min-h-screen bg-[oklch(98%_0_0)]">
  <%= render 'shared/navigation' %>

  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <!-- Left Column: Product Preview -->
      <div>
        <h2 class="text-2xl font-light text-[oklch(21%_0.006_285.885)] mb-6">
          <span class="font-bold">Product</span> Preview
        </h2>

        <!-- Mockup Image -->
        <div class="bg-white rounded-2xl shadow-lg border border-[oklch(88%_0_0)] p-6 mb-6">
          <div class="aspect-square rounded-lg overflow-hidden bg-[oklch(98%_0_0)]">
            <%= image_tag @mockup_data[:mockup_image_url],
                alt: "Product Mockup",
                class: "w-full h-full object-contain" %>
          </div>
          <p class="text-center text-sm text-[color-mix(in_oklab,oklch(21%_0.006_285.885)_70%,transparent)] mt-4">
            Product Mockup
          </p>
        </div>

        <!-- Original Design -->
        <div class="bg-white rounded-2xl shadow-lg border border-[oklch(88%_0_0)] p-6">
          <h3 class="text-lg font-semibold text-[oklch(21%_0.006_285.885)] mb-4">Your Design</h3>
          <div class="aspect-square rounded-lg overflow-hidden bg-[oklch(98%_0_0)]">
            <%= image_tag @mockup_data[:image_url],
                alt: "Original Design",
                class: "w-full h-full object-contain" %>
          </div>
        </div>
      </div>

      <!-- Right Column: Checkout Form -->
      <div>
        <h2 class="text-2xl font-light text-[oklch(21%_0.006_285.885)] mb-6">
          <span class="font-bold">Checkout</span> Details
        </h2>

        <!-- Order Summary -->
        <div class="bg-white rounded-2xl shadow-lg border border-[oklch(88%_0_0)] p-6 mb-6">
          <h3 class="text-xl font-bold text-[oklch(21%_0.006_285.885)] mb-4">Order Summary</h3>
          <div class="space-y-3">
            <div class="flex justify-between">
              <span class="text-[color-mix(in_oklab,oklch(21%_0.006_285.885)_70%,transparent)]">Product:</span>
              <span class="font-semibold text-[oklch(21%_0.006_285.885)]"><%= @mockup_data[:product_name] %></span>
            </div>
            <div class="flex justify-between">
              <span class="text-[color-mix(in_oklab,oklch(21%_0.006_285.885)_70%,transparent)]">Variant:</span>
              <span class="font-semibold text-[oklch(21%_0.006_285.885)]"><%= @mockup_data[:variant_name] %></span>
            </div>
            <div class="flex justify-between">
              <span class="text-[color-mix(in_oklab,oklch(21%_0.006_285.885)_70%,transparent)]">Product Price:</span>
              <span class="font-semibold text-[oklch(21%_0.006_285.885)]">$<%= sprintf("%.2f", @mockup_data[:base_price]) %></span>
            </div>
            <div class="flex justify-between">
              <span class="text-[color-mix(in_oklab,oklch(21%_0.006_285.885)_70%,transparent)]">Shipping:</span>
              <span class="font-semibold text-[oklch(21%_0.006_285.885)]">$<%= sprintf("%.2f", @mockup_data[:estimated_shipping]) %></span>
            </div>
            <div class="border-t border-[oklch(88%_0_0)] pt-3 mt-3">
              <div class="flex justify-between items-center">
                <span class="text-lg font-bold text-[oklch(21%_0.006_285.885)]">Total:</span>
                <span class="text-2xl font-bold text-[oklch(21%_0.006_285.885)]">$<%= sprintf("%.2f", @mockup_data[:base_price] + @mockup_data[:estimated_shipping]) %></span>
              </div>
            </div>
          </div>
        </div>

        <!-- Shipping Address Form -->
        <div class="bg-white rounded-2xl shadow-lg border border-[oklch(88%_0_0)] p-6 mb-6">
          <h3 class="text-xl font-bold text-[oklch(21%_0.006_285.885)] mb-4">Shipping Address</h3>
          <form id="shipping-form" class="space-y-4">
            <div class="form-control">
              <label class="label">
                <span class="label-text">Full Name</span>
              </label>
              <input type="text" id="shipping-name" name="name" required class="input input-bordered w-full" placeholder="John Doe">
            </div>

            <div class="form-control">
              <label class="label">
                <span class="label-text">Email</span>
              </label>
              <input type="email" id="shipping-email" name="email" required class="input input-bordered w-full" placeholder="you@example.com">
            </div>

            <div class="form-control">
              <label class="label">
                <span class="label-text">Address Line 1</span>
              </label>
              <input type="text" id="shipping-address1" name="address1" required class="input input-bordered w-full" placeholder="123 Main St">
            </div>

            <div class="form-control">
              <label class="label">
                <span class="label-text">Address Line 2 (Optional)</span>
              </label>
              <input type="text" id="shipping-address2" name="address2" class="input input-bordered w-full" placeholder="Apt 4B">
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div class="form-control">
                <label class="label">
                  <span class="label-text">City</span>
                </label>
                <input type="text" id="shipping-city" name="city" required class="input input-bordered w-full" placeholder="New York">
              </div>

              <div class="form-control">
                <label class="label">
                  <span class="label-text">State</span>
                </label>
                <input type="text" id="shipping-state" name="state" required class="input input-bordered w-full" placeholder="NY">
              </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div class="form-control">
                <label class="label">
                  <span class="label-text">ZIP Code</span>
                </label>
                <input type="text" id="shipping-zip" name="zip" required class="input input-bordered w-full" placeholder="10001">
              </div>

              <div class="form-control">
                <label class="label">
                  <span class="label-text">Country</span>
                </label>
                <select id="shipping-country" name="country" class="select select-bordered w-full">
                  <option value="US" selected>United States</option>
                  <option value="CA">Canada</option>
                  <option value="GB">United Kingdom</option>
                </select>
              </div>
            </div>

            <div class="form-control">
              <label class="label">
                <span class="label-text">Phone (Optional)</span>
              </label>
              <input type="tel" id="shipping-phone" name="phone" class="input input-bordered w-full" placeholder="+1 (555) 123-4567">
            </div>
          </form>
        </div>

        <!-- Payment Form -->
        <div class="bg-white rounded-2xl shadow-lg border border-[oklch(88%_0_0)] p-6">
          <h3 class="text-xl font-bold text-[oklch(21%_0.006_285.885)] mb-4">Payment Information</h3>

          <form id="payment-form" data-client-secret="<%= @client_secret %>" data-mockup-id="<%= params[:mockup_id] %>">
            <!-- Card Element -->
            <div class="form-control mb-4">
              <label class="label">
                <span class="label-text">Card Information</span>
              </label>
              <div id="card-element" class="px-3 py-3 border border-[oklch(88%_0_0)] rounded-lg bg-white focus-within:border-[oklch(14%_0.005_285.823)] focus-within:ring-2 focus-within:ring-[oklch(14%_0.005_285.823)]/20 transition">
                <!-- Stripe.js will insert the card element here -->
              </div>
            </div>

            <!-- Error messages -->
            <div id="card-errors" class="text-red-600 text-sm mb-4" role="alert"></div>

            <!-- Submit Button -->
            <button
              type="submit"
              id="submit-button"
              class="btn-primary-daisy w-full"
            >
              <span id="button-text">Complete Purchase - $<%= sprintf("%.2f", @mockup_data[:base_price] + @mockup_data[:estimated_shipping]) %></span>
              <span id="spinner" class="hidden">Processing...</span>
            </button>
          </form>

          <!-- Security Badge -->
          <div class="mt-6 flex items-center justify-center space-x-2 text-sm text-[color-mix(in_oklab,oklch(21%_0.006_285.885)_70%,transparent)]">
            <svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
            </svg>
            <span>Secured by Stripe</span>
          </div>

          <!-- Test Card Info -->
          <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
            <h4 class="font-semibold text-yellow-800 mb-2 text-sm">Test Mode - Use test card:</h4>
            <p class="text-sm text-yellow-700"><strong>4242 4242 4242 4242</strong></p>
            <p class="text-xs text-yellow-600 mt-1">Any future expiry date and any 3-digit CVC</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <%= render 'shared/footer' %>
</div>

<!-- Stripe.js -->
<script src="https://js.stripe.com/v3/"></script>
<script>
  // Initialize Stripe
  const stripe = Stripe('<%= Rails.configuration.stripe[:publishable_key] %>');
  const elements = stripe.elements();

  // Create card element
  const cardElement = elements.create('card', {
    style: {
      base: {
        fontSize: '16px',
        color: '#1f2937',
        fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
        '::placeholder': {
          color: '#9ca3af'
        }
      },
      invalid: {
        color: '#dc2626',
        iconColor: '#dc2626'
      }
    }
  });

  cardElement.mount('#card-element');

  // Handle real-time validation errors
  const displayError = document.getElementById('card-errors');
  cardElement.on('change', function(event) {
    if (event.error) {
      displayError.textContent = event.error.message;
    } else {
      displayError.textContent = '';
    }
  });

  // Handle form submission
  const form = document.getElementById('payment-form');
  const submitButton = document.getElementById('submit-button');
  const buttonText = document.getElementById('button-text');
  const spinner = document.getElementById('spinner');
  const shippingForm = document.getElementById('shipping-form');

  form.addEventListener('submit', async function(event) {
    event.preventDefault();

    // Validate shipping form
    if (!shippingForm.checkValidity()) {
      shippingForm.reportValidity();
      return;
    }

    // Disable button and show spinner
    submitButton.disabled = true;
    buttonText.classList.add('hidden');
    spinner.classList.remove('hidden');

    const clientSecret = form.dataset.clientSecret;

    // Confirm payment with Stripe
    const {error, paymentIntent} = await stripe.confirmCardPayment(clientSecret, {
      payment_method: {
        card: cardElement,
        billing_details: {
          name: document.getElementById('shipping-name').value,
          email: document.getElementById('shipping-email').value,
        }
      }
    });

    if (error) {
      displayError.textContent = error.message;
      submitButton.disabled = false;
      buttonText.classList.remove('hidden');
      spinner.classList.add('hidden');
    } else if (paymentIntent.status === 'succeeded') {
      // Create order via API
      const shippingAddress = {
        name: document.getElementById('shipping-name').value,
        email: document.getElementById('shipping-email').value,
        address1: document.getElementById('shipping-address1').value,
        address2: document.getElementById('shipping-address2').value,
        city: document.getElementById('shipping-city').value,
        state: document.getElementById('shipping-state').value,
        zip: document.getElementById('shipping-zip').value,
        country: document.getElementById('shipping-country').value,
        phone: document.getElementById('shipping-phone').value
      };

      try {
        const response = await fetch('/api/v1/orders', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-API-Key': 'internal'
          },
          body: JSON.stringify({
            mockup_id: form.dataset.mockupId,
            payment_intent_id: paymentIntent.id,
            shipping_address: shippingAddress
          })
        });

        const result = await response.json();

        if (result.success) {
          // Redirect to success page
          window.location.href = `/checkout/success?order_number=${result.order_number}`;
        } else {
          displayError.textContent = result.error || 'Failed to create order';
          submitButton.disabled = false;
          buttonText.classList.remove('hidden');
          spinner.classList.add('hidden');
        }
      } catch (err) {
        displayError.textContent = 'Network error. Please try again.';
        submitButton.disabled = false;
        buttonText.classList.remove('hidden');
        spinner.classList.add('hidden');
      }
    }
  });
</script>
